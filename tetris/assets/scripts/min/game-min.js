function Tetromino(){this.shape=Math.floor(Math.random()*nbBlockTypes),this.color=Math.floor(Math.random()*nbBlockTypes),this.sprites=[],this.cells=[],this.center=[0,0],this.materialize=function(e,t,o){this.center=[e,t],this.cells=[];for(var a=0;a<this.sprites.length;a++)this.sprites[a].destroy();this.sprites=[];for(var s=!1,n=0;blocksPerTetromino>n;n++){var r=e+offsets[this.shape][n][0],i=t+offsets[this.shape][n][1],l=game.add.sprite(r*blockSize,i*blockSize,"blocks",this.color);this.sprites.push(l),this.cells.push([r,i]),o&&(validateCoordinates(r,i)||(s=!0),scene[r][i]=blockValue)}return s}}function updateScore(){score+=scoreIncrement,completedLines++,scoreText.text=score,linesText.text=completedLines,alignText(),updateTimer()}function updateTimer(){completedLines%linesThreshold==0&&(loop.delay-=speedUp,scoreIncrement+=scorePlus)}function alignText(){var e=scoreTitle.x+scoreTitle.textWidth/2;scoreText.x=e-.5*scoreText.textWidth,linesText.x=e-.5*linesText.textWidth}function manageTetrominos(){for(;queue.length<nbNext+1;)queue.unshift(new Tetromino);tetromino=queue.pop();var e=Math.floor(blocksX/2),t=y_start[tetromino.shape],o=tetromino.materialize(e,t,!0);if(o)gameOver();else for(var a=0;a<queue.length;a++){var s=Math.floor((scoreTitle.x+scoreTitle.textWidth/2)/32),n=14;queue[a].materialize(s,n,!1)}}function slide(e,t){var o=tetromino.cells[e][0]+move_offsets[t][0],a=tetromino.cells[e][1]+move_offsets[t][1];return[o,a]}function slideCenter(e){var t=tetromino.center[0]+move_offsets[e][0],o=tetromino.center[1]+move_offsets[e][1];return[t,o]}function rotate(e,t){var o=tetromino.center[0],a=tetromino.center[1],s=tetromino.cells[e][0]-o,n=tetromino.cells[e][1]-a;n=-n;var r="clockwise"==t?n:-n,i="clockwise"==t?-s:s;i=-i;var l=o+r,d=a+i;return[l,d]}function canMove(e,t){if(pauseState)return!1;for(var o=0;o<tetromino.cells.length;o++){var a=e(o,t),s=a[0],n=a[1];if(!validateCoordinates(s,n))return!1}return!0}function validateCoordinates(e,t){return 0>e||e>blocksX-1?!1:0>t||t>blocksY-1?!1:scene[e][t]!=occupiedValue}function move(e,t,o,a){for(var s=0;s<tetromino.cells.length;s++){var n=tetromino.cells[s][0],r=tetromino.cells[s][1],i=e(s,o),l=i[0],d=i[1];tetromino.cells[s][0]=l,tetromino.cells[s][1]=d,tetromino.sprites[s].x=l*blockSize,tetromino.sprites[s].y=d*blockSize,scene[n][r]=0,scene[l][d]=blockValue}if(t){var c=t(o);tetromino.center=[c[0],c[1]]}a&&Game.radio.playSound(Game.radio.moveSound)}function lineSum(e){for(var t=0,o=0;blocksX>o;o++)t+=scene[o][e];return t}function checkLines(e){for(var t=[],o=0;o<e.length;o++){var a=lineSum(e[o]);a==blocksX*occupiedValue&&(updateScore(),t.push(e[o]),Game.radio.playSound(Game.radio.winSound),cleanLine(e[o]))}t.length&&collapse(t)}function cleanLine(e){for(var t=0,o=0;blocksX>o;o++){var a=game.add.tween(sceneSprites[o][e]);a.to({y:0},500,null,!1,t),a.onComplete.add(destroy,this),a.start(),sceneSprites[o][e]=null,scene[o][e]=0,t+=o%2===0?50:75}}function destroy(e){e.destroy()}function collapse(e){for(var t=999,o=0;o<e.length;o++)e[o]<t&&(t=e[o]);for(var a=t-1;a>=0;a--)for(var s=0;blocksX>s;s++)if(sceneSprites[s][a]){sceneSprites[s][a+e.length]=sceneSprites[s][a],sceneSprites[s][a]=null,scene[s][a+e.length]=occupiedValue,scene[s][a]=0;var n=game.add.tween(sceneSprites[s][a+e.length]),r=sceneSprites[s][a+e.length].y+e.length*blockSize;n.to({y:r},500,null,!1),n.start()}}function displayScene(){console.log("Scene length"+scene.length);for(var e=0;e<scene.length;e++)for(var t=0;t<scene[e].length;t++)console.log(scene[e][t])}function fall(){if(!pauseState&&!gameOverState)if(canMove(slide,"down"))move(slide,slideCenter,"down",0);else{for(var e=[],t=0;t<tetromino.cells.length;t++){-1==e.indexOf(tetromino.cells[t][1])&&e.push(tetromino.cells[t][1]);var o=tetromino.cells[t][0],a=tetromino.cells[t][1];scene[o][a]=occupiedValue,sceneSprites[tetromino.cells[t][0]][tetromino.cells[t][1]]=tetromino.sprites[t]}checkLines(e),manageTetrominos()}}function makeShade(){shade=game.add.graphics(0,0),shade.beginFill(0,.6),shade.drawRect(0,0,game.world.width,game.world.height),shade.endFill()}function managePauseScreen(){pauseState=!pauseState,pauseState?(Game.radio.music.pause(),makeShade(),pauseText=game.add.bitmapText(game.world.centerX,game.world.centerY,"videogame","PAUSE",64),pauseText.anchor.setTo(.5)):(timer.resume(),Game.radio.playMusic(),shade.clear(),pauseText.destroy())}function gameOver(){gameOverState=!0,game.input.keyboard.enabled=!1,Game.radio.music.pause(),Game.radio.playSound(Game.radio.gameOverSound),makeShade();var e=game.add.bitmapText(game.world.centerX,game.world.centerY,"gameover","GAME OVER",50);e.anchor.setTo(.5)}var Game={},blocksPerTetromino=4,nbBlockTypes=7,blockSize=32,blocksY=20,blocksX=10,gameWidth=blocksX*blockSize,menuWidth=250,movementLag=100,scoreX=gameWidth+90,nbNext=1,blockValue=1,occupiedValue=2,score=0,scoreIncrement=50,completedLines=0,linesThreshold=3,speedUp=100,scorePlus=25,timeOut=Phaser.Timer.SECOND,queue=[],pauseState=!1,gameOverState=!1,offsets={0:[[0,-1],[0,0],[0,1],[1,1]],1:[[0,-1],[0,0],[0,1],[-1,1]],2:[[-1,0],[0,0],[1,0],[2,0]],3:[[-1,-1],[0,-1],[0,0],[-1,0]],4:[[-1,0],[0,0],[0,-1],[1,-1]],5:[[-1,0],[0,0],[1,0],[0,1]],6:[[-1,-1],[0,-1],[0,0],[1,0]]},y_start={0:1,1:1,2:0,3:1,4:1,5:0,6:1},move_offsets={left:[-1,0],down:[0,1],right:[1,0]},tetromino,cursors,rotates,pause,pauseText,scoreTitle,scoreText,linesText,scene,sceneSprites,timer,loop,shade,currentMovementTimer=0;Game.radio={soundOn:!0,moveSound:null,gameOverSound:null,winSound:null,music:null,playMusic:function(){Game.radio.soundOn&&!pauseState&&Game.radio.music.resume()},manageSound:function(e){e.frame=1-e.frame,Game.radio.soundOn=!Game.radio.soundOn,Game.radio.soundOn?Game.radio.playMusic():Game.radio.music.pause()},playSound:function(e){Game.radio.soundOn&&!pauseState&&e.play()}},Game.preload=function(){game.load.spritesheet("blocks","assets/blocks.png",blockSize,blockSize,nbBlockTypes+1),game.load.spritesheet("sound","assets/sound.png",32,32),game.load.audio("move","assets/sound/move.mp3","assets/sound/move.ogg"),game.load.audio("win","assets/sound/win.mp3","assets/sound/win.ogg"),game.load.audio("gameover","assets/sound/gameover.mp3","assets/sound/gameover.ogg")},Game.create=function(){scene=[],sceneSprites=[];for(var e=0;blocksX>e;e++){for(var t=[],o=[],a=0;blocksY>a;a++)t.push(0),o.push(null);scene.push(t),sceneSprites.push(o)}pauseState=!1,gameOverState=!1;var s=game.add.graphics(gameWidth,0);s.lineStyle(3,16777215,1),s.lineTo(0,game.world.height),placeSeparators(),game.add.tileSprite(0,game.world.height-blockSize,gameWidth,blockSize,"blocks",0);var n=game.add.sprite(game.world.width-38,0,"sound",0);n.inputEnabled=!0,n.events.onInputDown.add(Game.radio.manageSound,this),scoreTitle=game.add.bitmapText(gameWidth+50,50,"videogame","Score",20),scoreText=game.add.bitmapText(gameWidth+50,100,"desyrel","0",40);var r=game.add.bitmapText(gameWidth+50,200,"videogame","Lines",20);linesText=game.add.bitmapText(gameWidth+50,250,"desyrel","0",40);var i=game.add.bitmapText(gameWidth+75,350,"videogame","Next",20);alignText(),i.x=scoreTitle.x+scoreTitle.textWidth/2-.5*i.textWidth,r.x=scoreTitle.x+scoreTitle.textWidth/2-.5*r.textWidth,manageTetrominos(),game.input.keyboard.enabled=!0,cursors={right:game.input.keyboard.addKey(Phaser.Keyboard[document.getElementById("moveright").value]),left:game.input.keyboard.addKey(Phaser.Keyboard[document.getElementById("moveleft").value]),down:game.input.keyboard.addKey(Phaser.Keyboard[document.getElementById("movedown").value])},rotates={counterClockwise:game.input.keyboard.addKey(Phaser.Keyboard[document.getElementById("rotateright").value]),clockwise:game.input.keyboard.addKey(Phaser.Keyboard[document.getElementById("rotateleft").value])},pause=game.input.keyboard.addKey(Phaser.Keyboard[document.getElementById("pause").value]),timer=game.time.events,loop=timer.loop(timeOut,fall,this),timer.start(),Game.radio.moveSound=game.add.audio("move"),Game.radio.winSound=game.add.audio("win"),Game.radio.gameOverSound=game.add.audio("gameover"),Game.radio.music=game.add.audio("music"),Game.radio.music.volume=.2,Game.radio.music.loopFull()},Game.update=function(){currentMovementTimer+=this.time.elapsed,currentMovementTimer>movementLag&&(pause.isDown&&managePauseScreen(),cursors.left.isDown?canMove(slide,"left")&&move(slide,slideCenter,"left",1):cursors.right.isDown?canMove(slide,"right")&&move(slide,slideCenter,"right",1):cursors.down.isDown?canMove(slide,"down")&&move(slide,slideCenter,"down",1):rotates.clockwise.isDown?canMove(rotate,"clockwise")?move(rotate,null,"clockwise",1):console.log("Cannot rotate"):rotates.counterClockwise.isDown&&(canMove(rotate,"counterclockwise")?move(rotate,null,"counterclockwise",1):console.log("Cannot rotate")),currentMovementTimer=0)};